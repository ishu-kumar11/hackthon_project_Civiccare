{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/public_issues.css' %}">

<section class="public-issues">

    <!-- Page Header -->
    <div class="page-header">
        <h1>{% trans "Public Issues" %}</h1>
        <p>{% trans "Transparent view of issues reported by citizens" %}</p>
    </div>

    <!-- Filters -->
    <form method="GET" class="filters">

        <select name="category" onchange="this.form.submit()">
            <option value="">{% trans "All Categories" %}</option>
            <option value="road" {% if request.GET.category == "road" %}selected{% endif %}>
                {% trans "Road & Potholes" %}
            </option>
            <option value="water" {% if request.GET.category == "water" %}selected{% endif %}>
                {% trans "Water Supply" %}
            </option>
            <option value="electricity" {% if request.GET.category == "electricity" %}selected{% endif %}>
                {% trans "Electricity" %}
            </option>
            <option value="garbage" {% if request.GET.category == "garbage" %}selected{% endif %}>
                {% trans "Garbage & Sanitation" %}
            </option>
            <option value="street" {% if request.GET.category == "street" %}selected{% endif %}>
                {% trans "Street Lights" %}
            </option>
        </select>

        <select name="status" onchange="this.form.submit()">
            <option value="">{% trans "All Status" %}</option>
            <option value="pending" {% if request.GET.status == "pending" %}selected{% endif %}>
                {% trans "Pending" %}
            </option>
            <option value="in_progress" {% if request.GET.status == "in_progress" %}selected{% endif %}>
                {% trans "In Progress" %}
            </option>
            <option value="resolved" {% if request.GET.status == "resolved" %}selected{% endif %}>
                {% trans "Resolved" %}
            </option>
        </select>

    </form>

    <!-- Issues Grid -->
    <div class="issues-grid">

        {% for issue in issues %}
        <div class="issue-card">

            <div class="issue-top">
                <h3>{{ issue.title }}</h3>
                {% if issue.is_fake %}
                    <span class="status fake fake-badge">
                        {% trans "Marked Fake" %}
                    </span>
                {% else %}
                    <span class="status {{ issue.status|lower }}">
                        {{ issue.get_status_display }}
                    </span>
                {% endif %}

            </div>

            <p class="meta">
                <strong>{% trans "Category:" %}</strong>
                {{ issue.get_category_display }}
            </p>

            <p class="meta">
                <strong>{% trans "Location:" %}</strong>
                {{ issue.location }} ({{ issue.district }}, {{ issue.state }})
            </p>


            <p class="meta">
                <strong>{% trans "Reported:" %}</strong>
                {{ issue.created_at|date:"d M Y" }}
            </p>

            <!-- ===== VOTING SECTION ===== -->
    
             
<div class="vote-section">

  {% if user.is_authenticated and not issue.is_fake %}
    <div class="vote-buttons">

      <button type="button" class="vote-btn real"
              onclick="voteIssue({{ issue.id }}, 'real')"
              title="This issue is real">
        ğŸ‘
        <span class="vote-count" id="real-count-{{ issue.id }}">
          {{ issue.real_votes }}
        </span>
      </button>

      <button type="button" class="vote-btn fake"
              onclick="voteIssue({{ issue.id }}, 'fake')"
              title="This issue is fake or incorrect">
        ğŸ‘
        <span class="vote-count" id="fake-count-{{ issue.id }}">
          {{ issue.fake_votes }}
        </span>
      </button>

    </div>

    <p class="vote-message" id="vote-msg-{{ issue.id }}"></p>

  {% elif issue.is_fake %}
    <p class="fake-warning">
      ğŸš« {% trans "This issue was marked fake by authorities" %}
    </p>

  {% else %}
    <p class="login-hint">
      ğŸ”’ <a href="{% url 'login' %}?next={{ request.path }}">
        {% trans "Login to vote" %}
      </a>
    </p>
  {% endif %}

</div>

<!-- ===== END VOTING SECTION ===== -->



        </div>

        {% empty %}
        <p class="no-data">{% trans "No public issues available." %}</p>
        {% endfor %}

    </div>

</section>

<script src="{% static 'Javascript/voting.js' %}"></script>

<script>
  const VOTE_URL_TEMPLATE = "{% url 'vote_issue' 0 %}";
</script>

{% endblock %}
